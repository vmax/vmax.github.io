<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <title>Python concurrency gotcha</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="https://vmax.dev/main.css">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZHVH8SD2XC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ZHVH8SD2XC');
    </script>

    
    
</head>
<body>
    <div class="container">
        <label class="site-title">vmax.dev</label>
        <main id="main" tabindex="-1">
            

<article class="post">
    <a class="baselink" href="https:&#x2F;&#x2F;vmax.dev">&larr;</a>
    <header>
        <h1>Python concurrency gotcha</h1>
    </header>
    <div class="content">
        <p>Asynchronous functions are usually a good way to optimize I/O bound tasks. However,
one must be careful passing values to different threads, especially those that change.
What do you think this code would output?</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">from </span><span>concurrent.futures </span><span style="color:#b48ead;">import </span><span>ThreadPoolExecutor
</span><span>ex = </span><span style="color:#bf616a;">ThreadPoolExecutor</span><span>()
</span><span style="color:#b48ead;">for </span><span>i </span><span style="color:#b48ead;">in </span><span style="color:#96b5b4;">range</span><span>(</span><span style="color:#d08770;">100</span><span>):
</span><span>    ex.</span><span style="color:#bf616a;">submit</span><span>(</span><span style="color:#b48ead;">lambda</span><span>: </span><span style="color:#96b5b4;">print</span><span>(i, </span><span style="color:#bf616a;">end</span><span>=&#39;</span><span style="color:#a3be8c;">, </span><span>&#39;))
</span></code></pre>
<p>Well, before I'd answer it'd print all 100 numbers but not in correct order. However, this is
completely wrong. This is what I got running on my machine (you result would vary):</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>0, 2, 2, 5, 5, 5, 9, 9, 9, 9, 14, 14, 14, 14, 14, 20, 20, 20, 20, 20, 20, 27, 27, 27, 27, 27, 27, 27, 35, 35, 35, 35, 35, 35, 35, 35, 44, 44, 44, 44, 44, 44, 44, 44, 44, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 77, 77, 77, 77, 77, 77, 77, 77, 77, 77, 77, 77, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99,
</span></code></pre>
<p>The reason for it is that <code>i</code>, being shared between all threads (main and ones in executor), is getting modified <em>before</em> it gets a chance to be printed.</p>
<p>A way to overcome it would be to make sure that we don't use the variable itself but its value <strong>at the time we submit a task to the executor</strong>.
Simplest way to do that would be to use <a href="https://docs.python.org/3/library/functools.html#functools.partial"><code>functools.partial</code></a>:</p>
<blockquote>
<p>The partial() is used for partial function application which “freezes” some portion of a function’s arguments and/or keywords resulting in a new object with a simplified signature.</p>
</blockquote>
<p>The <em>&quot;freezes&quot;</em> bit is the one we're interested in.</p>
<p>Code sample:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">from </span><span>concurrent.futures </span><span style="color:#b48ead;">import </span><span>ThreadPoolExecutor
</span><span style="color:#b48ead;">from </span><span>functools </span><span style="color:#b48ead;">import </span><span>partial
</span><span>
</span><span>ex = </span><span style="color:#bf616a;">ThreadPoolExecutor</span><span>()
</span><span>
</span><span style="color:#b48ead;">for </span><span>i </span><span style="color:#b48ead;">in </span><span style="color:#96b5b4;">range</span><span>(</span><span style="color:#d08770;">100</span><span>):
</span><span>    ex.</span><span style="color:#bf616a;">submit</span><span>(</span><span style="color:#bf616a;">partial</span><span>(</span><span style="color:#96b5b4;">print</span><span>, i, </span><span style="color:#bf616a;">end</span><span>=&#39;</span><span style="color:#a3be8c;">, </span><span>&#39;))
</span></code></pre>
<p>As expected, this one would print all numbers:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99,
</span></code></pre>
<p>With operations more complex than print, the order would vary based on which thread completes the task earlier.</p>

    </div>

    
    <div class="article-info">
        
        <div class="article-date">2021-01-15</div>
        
    </div>

</article>

<script src="https://utteranc.es/client.js"
        repo="vmax/vmax.github.io"
        issue-term="url"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


        </main>
    </div>
</body>
</html>
